* Cowbuilder
** Environment

   #+BEGIN_SRC shell
     sudo apt install cowbuilder
   #+END_SRC
* Jenkins
** Run test in worksapce
** Show coverage

   Install coverage converting tool and convert to xml from [[https://stackoverflow.com/questions/31413281/golang-coverprofile-output-format][here]]

   #+BEGIN_SRC shell
     go get github.com/axw/gocov/gocov
     go get github.com/AlekSi/gocov-xml

     go test -coverprofile=cover.out
     gocov convert cover.out | gocov-xml > coverage.xml
   #+END_SRC
** Pipeline

   #+BEGIN_SRC groovy
     node (label: 'aws-builder') {
         ws("${WORKSPACE}/builds/${BUILD_ID}") {
             withEnv(["GOPATH=${WORKSPACE}", "GOROOT=/usr/lib/go", "repo=src/github.com/bitmark-inc"]) {
                 env.PATH="${GOROOT}/bin:$PATH"

                 stage('Checkout') {
                     echo 'Checking out from repository'
                     // git branch: 'master', url: 'https://github.com/bitmark-inc/bitmarkd'
                     // sh 'go get -d -v github.com/bitmark-inc/bitmarkd'
                     sh 'cd ${WORKSPACE} && mkdir -p \$repo && cd \$repo && git clone https://github.com/bitmark-inc/bitmarkd.git'
                 }

                 stage('Pre Test') {
                     echo 'Pulling dependencies'
                     sh 'go version'
                 }

                 stage('Test') {
                     filename = 'coverage.out'
                     sh 'cd ${WORKSPACE}/\$repo/bitmarkd && go get -t -d -v ./... && go test -cover -coverprofile=${filename} -covermode=count $(go list ./... | grep -v /vendor/) || ~/go/bin/gocov convert ${filename}  | ~/go/bin/gocov-xml > coverage.xml'
                 }
             }
         }
     }
   #+END_SRC
